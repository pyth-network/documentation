import { Callout, Tabs, Steps } from "nextra/components";

# SVM Searcher Integration

SVM Express Relay searchers fulfill opportunities representing limit orders on the [Limo](https://solscan.io/account/LiMoM9rMhrdYrfzUCxQppvxCSG1FcrUK9G8uLq4A1GF) program.

Bids are represented via [SVM transactions](https://solana.com/docs/core/transactions) that include instructions for submitting the bid.

<Steps>

### Subscribe to SVM chain

Searchers can use [Typescript](https://github.com/pyth-network/per/tree/4be711525948cf24c0ebd4ebab007dc7f51b7069/sdk/js)
and [Python](https://github.com/pyth-network/per/tree/4be711525948cf24c0ebd4ebab007dc7f51b7069/sdk/python) SDKs to interact with auction server.
Searchers can also directly fetch available opportunities via HTTP or subscribe to them via WebSocket.

<Callout type="warning" emoji="⚠️">
  Polling the server via HTTP for new opportunities is not recommended because
  of the additional delay it may incur. This can lead to late bid submissions
  which will be rejected. Some submission information such as the most recent
  blockhash and priority fees are **only** broadcasted via websocket.
</Callout>

<Tabs items={['Typescript', 'Python', 'HTTP', 'WebSocket']}>

<Tabs.Tab>
```typescript
import { Client, Opportunity } from "@pythnetwork/express-relay-js";

latestChainUpdate: Record<string, SvmChainUpdate> = {}

const handleOpportunity = async (opportunity: Opportunity) => {
    console.log("Received opportunity");
    // Implement your opportunity handler here
};

const svmChainUpdateHandler = async (update: SvmChainUpdate) {
    // Store chain updates to use when constructing the transaction
    latestChainUpdate[update.chainId] = update;
}

const client = new Client(
    { baseUrl: "https://pyth-express-relay-mainnet.asymmetric.re" },
    undefined, // Default WebSocket options
    handleOpportunity,
    undefined,
    svmChainUpdateHandler
);

async function main() {
    await client.subscribeChains(["solana"]);
}

main();

````

</Tabs.Tab>
<Tabs.Tab>
```python copy
import asyncio
from express_relay.client import (
    ExpressRelayClient,
)
from express_relay.models import Opportunity

latest_chain_update = {}

async def opportunity_callback(opportunity: Opportunity):
    print("Received opportunity")
    # Implement your opportunity handler here

async def svm_chain_update_callback(svm_chain_update: SvmChainUpdate):
    # Store chain updates to use when constructing the transaction
    latest_chain_update[svm_chain_update.chain_id] = svm_chain_update

client = ExpressRelayClient(
    "https://pyth-express-relay-mainnet.asymmetric.re",
    None,
    opportunity_callback,
    None,
    svm_chain_update_callback
)

async def main():
    await client.subscribe_chains(["solana"])
    task = await client.get_ws_loop()
    await task

if __name__ == "__main__":
    asyncio.run(main())
````

</Tabs.Tab>
<Tabs.Tab>
Searchers can request opportunities through an HTTP **GET** call to the [`/v1/opportunities`](https://pyth-express-relay-mainnet.asymmetric.re/docs#tag/opportunity/operation/get_opportunities) endpoint.

```bash copy
curl -X 'GET' \
  'https://pyth-express-relay-mainnet.asymmetric.re/v1/opportunities?chain_id=solana&mode=live'
```

</Tabs.Tab>
<Tabs.Tab>
Searchers can connect to the server via WebSocket to reduce latency and subscribe to various events. The WebSocket endpoint lives at `/v1/ws`(e.g `wss://pyth-express-relay-mainnet.asymmetric.re/v1/ws`).
Here is a sample JSON payload to subscribe to opportunities:

```bash copy
{
  "id": "1",
  "method": "subscribe",
  "params": {
    "chain_ids": ["solana"]
  }
}
```

Consult [`WebSocket API reference`](./websocket-api-reference.mdx) for a complete list of methods and parameters.

</Tabs.Tab>
</Tabs>

The server responds with opportunities in the following format:

```json copy
{
  // The Limo order to be executed, encoded in base64
  "order": "UxMUbQAsjrfQUp5stVwMJ6Mucq7VWTvt4ICe69BJ8lVXqwM+0sysV8OqZTdM0W4p...",
  // Address of the order account
  "order_address": "DUcTi3rDyS5QEmZ4BNRBejtArmDCWaPYGfN44vBJXKL5",
  // Identifier of the program that the order exists in
  "program": "limo",
  "chain_id": "solana",
  // Opportunity format version
  "version": "v1",
  "opportunity_id": "271f2a7b-1ec5-420f-b5c0-e3e4317f3d7b",
  // Creation time of the opportunity (in microseconds since the Unix epoch)
  "creation_time": 1733503592579589,
  "slot": 305802439
}
```

The `order` field includes the [Limo](https://solscan.io/account/LiMoM9rMhrdYrfzUCxQppvxCSG1FcrUK9G8uLq4A1GF) program
order data that can be decoded using the SDKs provided or the program anchor idl. It includes all the necessary information
to fill the limit order:
- Maker address
- Input token and amount (what the maker is selling)
- Output token and amount (what the maker is buying in exchange for the input token)

<Callout type="info">
  Limo limit orders can also be filled partially in a linear fashion. For
  example, if the order is to buy 10 SOL for \$2000, you can provide 5 SOL and
  get back \$1000.
</Callout>

The auction server also broadcast chain specific information that are necessary for building the transaction:

```json copy
{
  "type": "svm_chain_update",
  "update": {
    "chain_id": "development-solana",
    // Recent blockhash that you can use when constructing the transaction
    "blockhash": "6YK9yt6T1NhWNLhRGMapFxreYx6HPcW7RRcNSDsXjnLb",
    // Latest prioritization fee that is necessary to include in the transaction
    "latest_prioritization_fee": 319592
  }
}
```

### Construct the Bid

Searchers should construct a bid by evaluating the fetched opportunity.

<Callout type="warning" emoji="⚠️">
  Before constructing the bid, make sure your wallet has the required assets to
  fulfill the limit order and SOL to pay the bid amount.
</Callout>

See the following examples of how to construct a bid object via the SDKs:

<Tabs items={['Typescript', 'Python']}>
<Tabs.Tab>
Below is an excerpt of example code. See the full example in the [Typescript SDK](https://github.com/pyth-network/per/blob/4be711525948cf24c0ebd4ebab007dc7f51b7069/sdk/js/src/examples/simpleSearcherLimo.ts).

```typescript copy
import { OpportunitySvm } from "../index";
import { BidSvm } from "../types";

import * as anchor from "@coral-xyz/anchor";
import * as limo from "@kamino-finance/limo-sdk";

/**
  * Generates a bid for a given opportunity. The transaction in this bid transfers assets from the searcher's wallet to fulfill the limit order.
  * @param opportunity The SVM opportunity to bid on
  * @returns The generated bid object
  */
async generateBid(opportunity: OpportunitySvm): Promise<BidSvm> {
  const order = opportunity.order;
  const limoClient = new limo.LimoClient(
    this.connectionSvm,
    order.state.globalConfig
  );

  const ixsTakeOrder = await this.generateTakeOrderIxs(limoClient, order);
  const feeInstruction = ComputeBudgetProgram.setComputeUnitPrice({
    microLamports:
      this.latestChainUpdate[this.chainId].latestPrioritizationFee,
  });
  const txRaw = new anchor.web3.Transaction().add(
    feeInstruction,
    ...ixsTakeOrder
  );

  const bidAmount = await this.getBidAmount(order);

  const config = await this.getExpressRelayConfig();
  const bid = await this.client.constructSvmBid(
    txRaw,
    this.searcher.publicKey,
    getPdaAuthority(limoClient.getProgramID(), order.state.globalConfig),
    order.address,
    bidAmount,
    new anchor.BN(Math.round(Date.now() / 1000 + DAY_IN_SECONDS)),
    this.chainId,
    config.relayerSigner,
    config.feeReceiverRelayer
  );

  bid.transaction.recentBlockhash =
    this.latestChainUpdate[this.chainId].blockhash;
  bid.transaction.sign(this.searcher);
  return bid;
}
```

</Tabs.Tab>
<Tabs.Tab>
Below is an excerpt of example code. See the full example in the [Python SDK](https://github.com/pyth-network/per/blob/4be711525948cf24c0ebd4ebab007dc7f51b7069/sdk/python/express_relay/searcher/examples/simple_searcher_svm.py).

```python copy
import logging

from solders.transaction import Transaction

from express_relay.models.svm import BidSvm
from express_relay.svm.limo_client import OrderStateAndAddress

DEADLINE = 2 * 10**10
logger = logging.getLogger(__name__)

async def assess_opportunity(self, opp: OpportunitySvm) -> BidSvm | None:
    """
    Method to assess an opportunity and return a bid if the opportunity is worth taking. This method always returns a bid for any valid opportunity. The transaction in this bid transfers assets from the searcher's wallet to fulfill the limit order.

    Args:
        opp: An object representing a single opportunity.
    Returns:
        A bid object if the opportunity is worth taking to be submitted to the Express Relay server, otherwise None.
    """
    order: OrderStateAndAddress = {"address": opp.order_address, "state": opp.order}

    ixs_take_order = await self.generate_take_order_ixs(order)
    bid_amount = await self.get_bid_amount(order)
    router = self.limo_client.get_pda_authority(
        self.limo_client.get_program_id(), order["state"].global_config
    )

    submit_bid_ix = self.client.get_svm_submit_bid_instruction(
        searcher=self.private_key.pubkey(),
        router=router,
        permission_key=order["address"],
        bid_amount=bid_amount,
        deadline=DEADLINE,
        chain_id=self.chain_id,
        fee_receiver_relayer=(await self.get_metadata()).fee_receiver_relayer,
        relayer_signer=(await self.get_metadata()).relayer_signer,
    )
    latest_chain_update = self.latest_chain_update[self.chain_id]
    fee_instruction = set_compute_unit_price(
        latest_chain_update.latest_prioritization_fee
    )
    transaction = Transaction.new_with_payer(
        [fee_instruction, submit_bid_ix] + ixs_take_order, self.private_key.pubkey()
    )
    transaction.partial_sign(
        [self.private_key], recent_blockhash=latest_chain_update.blockhash
    )
    bid = BidSvm(transaction=transaction, chain_id=self.chain_id)
    return bid
```

</Tabs.Tab>
</Tabs>

The bid you construct will look like

```json
{
  // serialized transaction object, in base-64 encoding
  "transaction": "SGVsbG8sIFdvcmxkIQ==",
  "chain_id": "solana"
}
```

The transaction submitted to the auction server as the bid should meet the following criteria:
    - It should contain an Express Relay `SubmitBid` instruction that specifies the amount you are bidding, the permission details, and the deadline.
This instruction can be created via the SDKs.
    - The deadline specified in the `SubmitBid` instruction should be at least 5 seconds in the future.
    - It should contain an instruction to set the [transaction priority fee](https://solana.com/developers/guides/advanced/how-to-use-priority-fees#what-are-priority-fees). The priority fee should be at least as large the amount
advertised via websocket.
    - It should contain valid signatures for all signers except the relayer
    - It should pass simulation

### Submit Bids on Opportunities to Express Relay

Searchers can submit their constructed bids to Express Relay via the SDKs, an HTTP POST request, or a WebSocket connection.

<Tabs items={['Typescript', 'Python', 'HTTP', 'WebSocket']}>

<Tabs.Tab>

The code snippet below demonstrates how to submit a bid using the Typescript SDK:

```typescript {8} copy
const generateBid = async (opportunity: OpportunitySvm, recentBlockhash: Blockhash): BidSvm => {
    ...
}

const handleOpportunity = async (opportunity: Opportunity) => {
    ...
    const bid = await this.generateBid(opportunity as OpportunitySvm);
    await client.submitBid(bid);
}
```

</Tabs.Tab>
<Tabs.Tab>

The code snippet below demonstrates how to submit a bid using the Python SDK:

```python {8} copy
import typing

async def generate_bid(opp: OpportunitySvm) -> BidSvm:
    ...

def opportunity_callback(opportunity: Opportunity):
    bid = await self.assess_opportunity(typing.cast(OpportunitySvm, opp))
    await client.submit_bid(bid, subscribe_to_updates=True)
```

</Tabs.Tab>
<Tabs.Tab>
Searchers can submit bids through an HTTP POST call to the [`/v1/bids`](https://pyth-express-relay-mainnet.asymmetric.re/docs#tag/bid/operation/bid) endpoint. This endpoint accepts a JSON payload containing the details of the bid.

```bash copy
curl -X POST https://pyth-express-relay-mainnet.asymmetric.re/v1/bids \
    -H "Content-Type: application/json" \
    -d '{
    "chain_id": "solana",
    "transaction": "SGVsbG8sIFdvcmxkIQ=="
}'
```

</Tabs.Tab>
<Tabs.Tab>

Searchers can submit bids via WebSocket to avoid additional network round-trips and get notified about changes to the bid status.

```bash copy
{
  "id": "1",
  "method": "post_bid",
  "params": {
    "bid": {
      "chain_id": "solana",
      "transaction": "SGVsbG8sIFdvcmxkIQ=="
    }
  }
}
```

A successful response to a bid submission has the following schema:

```bash copy
{
  // WebSocket request id
  "id": "1",
  "status": "success",
  "result": {
    // Bid id
    "id": "beedbeed-b346-4fa1-8fab-2541a9e1872d",
    "status": "OK"
  }
}
```

Consult [`WebSocket API reference`](../websocket-api-reference.mdx) for more details.

</Tabs.Tab>
</Tabs>
</Steps>
